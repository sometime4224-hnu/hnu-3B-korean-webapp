import React, { useState, useEffect, useCallback } from 'react';
import { Settings, X, Check, Trophy, Users, RefreshCw } from 'lucide-react';

// ì¹´ë“œ ì»´í¬ë„ŒíŠ¸
const Card = ({ id, isFlipped, result, onClick, disabled }) => {
  return (
    <div 
      className={`relative h-32 w-full cursor-pointer transition-all duration-500 [transform-style:preserve-3d] ${isFlipped ? '[transform:rotateY(180deg)]' : ''} ${disabled ? 'cursor-not-allowed' : 'hover:-translate-y-1'}`}
      onClick={() => !disabled && onClick(id)}
    >
      {/* ì¹´ë“œ ë’·ë©´ (í´ë¦­ ì „) */}
      <div className="absolute inset-0 w-full h-full bg-indigo-600 rounded-xl shadow-md border-4 border-indigo-200 flex items-center justify-center [backface-visibility:hidden]">
        <span className="text-3xl font-bold text-white opacity-50">{id + 1}</span>
      </div>

      {/* ì¹´ë“œ ì•ë©´ (ê²°ê³¼) */}
      <div className={`absolute inset-0 w-full h-full rounded-xl shadow-lg flex flex-col items-center justify-center p-2 [backface-visibility:hidden] [transform:rotateY(180deg)] ${result === 'winner' ? 'bg-yellow-100 border-4 border-yellow-400' : 'bg-gray-100 border-2 border-gray-300'}`}>
        {result === 'winner' ? (
          <>
            <Trophy className="w-8 h-8 text-yellow-600 mb-1 animate-bounce" />
            <span className="font-extrabold text-xl text-yellow-700">ë°˜ì¥!</span>
          </>
        ) : (
          <span className="text-gray-400 font-bold text-lg">ê½</span>
        )}
      </div>
    </div>
  );
};

// í•™ìƒ ëª…ë‹¨ ì•„ì´í…œ ì»´í¬ë„ŒíŠ¸
const StudentItem = ({ name, status, index }) => {
  let baseClass = "flex items-center gap-3 p-3 rounded-lg text-sm font-medium transition-all duration-300 ";
  
  if (status === 'current') {
    baseClass += "bg-indigo-600 text-white shadow-lg scale-105 border-l-4 border-yellow-400";
  } else if (status === 'done') {
    baseClass += "bg-gray-100 text-gray-400 line-through";
  } else {
    baseClass += "bg-white text-gray-600 border border-gray-100";
  }

  return (
    <div className={baseClass}>
      <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs ${status === 'current' ? 'bg-white text-indigo-600 font-bold' : 'bg-gray-200'}`}>
        {index + 1}
      </div>
      <span className="truncate">{name}</span>
      {status === 'current' && <span className="ml-auto text-xs bg-yellow-400 text-yellow-900 px-2 py-0.5 rounded-full animate-pulse">ì„ íƒ ì¤‘</span>}
    </div>
  );
};

// í­ì£½ íš¨ê³¼
const Confetti = ({ active }) => {
  if (!active) return null;
  return (
    <div className="fixed inset-0 pointer-events-none z-50 overflow-hidden">
      {[...Array(50)].map((_, i) => (
        <div
          key={i}
          className="absolute animate-confetti"
          style={{
            left: `${Math.random() * 100}%`,
            top: `-5%`,
            backgroundColor: ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff'][Math.floor(Math.random() * 5)],
            width: '10px',
            height: '10px',
            animationDelay: `${Math.random() * 2}s`,
            animationDuration: `${2 + Math.random() * 3}s`
          }}
        />
      ))}
    </div>
  );
};

export default function App() {
  const initialNames = [
    "ì§  í‘¹ ì½´", "íƒ€ í‹° ë¯¼ íŠ¸", "ì‘ì›¬ ë°˜ í‘¹", "ì‘ì›¬ ì‘ì–µ ë§ˆì´",
    "ì¿ ì—‡ë°˜íƒ•", "ì‘ì›¬ í‹° ì‘ì›» ì‘ì•„", "ì‘ìš°ì˜Œ ë¯¼ íˆì—ìš°", "ì‘ì›¬ í‹°ì—” í—™",
    "ì‘ì›¬ í‹° íƒ€ì‰ ì§±", "ì‘ì›¬ ë””ì—” ë‹·", "íŒœ ê¾¸ì˜¥ ìƒ", "ë³´ ì‘¤ì•ˆ íƒ€ì´",
    "ë²„ ëŠ ê¾¸ì‰", "ì§  ë‹¹ êµ¬ì¸ í”„ì—‰", "í›„ì‰ ë ˆ ê¾¸ì–µ ì•ˆ", "ì©ì•„ì‰ì¦ˆì—‰",
    "ì‘ì›¬ ë¹„ì—£ ê¾¸ì–µ", "ë ˆ ë¶€ í•˜", "ì‘ìš°ì˜Œ í‹° ì§€ì•™", "ì§  í‹° ìº„ ë¦¬",
    "ë˜ í‹° í›„ì—” ì§±", "ì¯”ì—‰ í‹° íŠ€ í™"
  ];

  const [cards, setCards] = useState([]);
  const [shuffledStudents, setShuffledStudents] = useState([]);
  const [currentTurnIndex, setCurrentTurnIndex] = useState(0);
  
  const [targetWinnerName, setTargetWinnerName] = useState(null); // ì¡°ì‘ëœ ë‹¹ì²¨ì ì´ë¦„
  const [preAssignedWinningCardId, setPreAssignedWinningCardId] = useState(null); // ëœë¤ ëª¨ë“œì¼ ë•Œ ë‹¹ì²¨ ì¹´ë“œ ID
  
  const [isSettingsOpen, setIsSettingsOpen] = useState(false);
  const [gameStatus, setGameStatus] = useState('ready'); // ready, playing, ended
  const [hasFirstCardFlipped, setHasFirstCardFlipped] = useState(false);

  // ê²Œì„ ì´ˆê¸°í™”
  const initGame = useCallback(() => {
    // 1. ì¹´ë“œ ìƒì„± (ìˆœìˆ˜í•œ ì¹´ë“œ, ë‚´ìš©ì€ ì•„ì§ ê²°ì •ë˜ì§€ ì•ŠìŒ or ëœë¤ ëª¨ë“œë©´ ë¯¸ë¦¬ ê²°ì •)
    const newCards = Array(initialNames.length).fill(null).map((_, i) => ({
      id: i,
      isFlipped: false,
      result: null // 'winner' or 'loser' or null
    }));
    setCards(newCards);

    // 2. í•™ìƒ ëª…ë‹¨ ì„ê¸°
    const shuffled = [...initialNames].sort(() => Math.random() - 0.5);
    setShuffledStudents(shuffled);

    // 3. ìƒíƒœ ì´ˆê¸°í™”
    setCurrentTurnIndex(0);
    setGameStatus('ready');
    setHasFirstCardFlipped(false);
    
    // 4. (ëœë¤ ëª¨ë“œì¼ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´) ë¯¸ë¦¬ ë‹¹ì²¨ ì¹´ë“œ ë²ˆí˜¸ í•˜ë‚˜ ë½‘ì•„ë‘ê¸°
    const randomWinnerId = Math.floor(Math.random() * initialNames.length);
    setPreAssignedWinningCardId(randomWinnerId);

  }, []);

  useEffect(() => {
    initGame();
  }, [initGame]);

  const handleCardClick = (cardId) => {
    if (gameStatus === 'ended') return;
    
    // ì´ë¯¸ ë’¤ì§‘íŒ ì¹´ë“œëŠ” ë¬´ì‹œ
    const clickedCard = cards.find(c => c.id === cardId);
    if (clickedCard.isFlipped) return;

    // ì²« ì¹´ë“œ ë’¤ì§‘í˜ í‘œì‹œ (ì„¤ì • ì ê¸ˆìš©)
    if (!hasFirstCardFlipped) {
      setHasFirstCardFlipped(true);
      setGameStatus('playing');
    }

    const currentStudent = shuffledStudents[currentTurnIndex];
    let isWinner = false;

    // ìŠ¹íŒ¨ ê²°ì • ë¡œì§
    if (targetWinnerName) {
      // ì¡°ì‘ ëª¨ë“œ: í˜„ì¬ ìˆœì„œê°€ íƒ€ê²Ÿ í•™ìƒì´ë©´ ë¬´ì¡°ê±´ ë‹¹ì²¨, ì•„ë‹ˆë©´ ë¬´ì¡°ê±´ ê½
      if (currentStudent === targetWinnerName) {
        isWinner = true;
      } else {
        isWinner = false;
      }
    } else {
      // ëœë¤ ëª¨ë“œ: ë¯¸ë¦¬ ë½‘ì•„ë‘” ì¹´ë“œ IDì™€ ì¼ì¹˜í•˜ë©´ ë‹¹ì²¨
      if (cardId === preAssignedWinningCardId) {
        isWinner = true;
      } else {
        isWinner = false;
      }
    }

    // ì¹´ë“œ ìƒíƒœ ì—…ë°ì´íŠ¸
    setCards(prev => prev.map(card => {
      if (card.id === cardId) {
        return { ...card, isFlipped: true, result: isWinner ? 'winner' : 'loser' };
      }
      return card;
    }));

    if (isWinner) {
      setGameStatus('ended');
    } else {
      // ë‹¤ìŒ ì°¨ë¡€ë¡œ ë„˜ê¸°ê¸°
      if (currentTurnIndex < shuffledStudents.length - 1) {
        setCurrentTurnIndex(prev => prev + 1);
      } else {
        // ëª¨ë“  í•™ìƒì´ ë‹¤ ë½‘ì•˜ëŠ”ë° ë‹¹ì²¨ìê°€ ì—†ëŠ” ê²½ìš° (ì¡°ì‘ ëª¨ë“œ ì˜¤ë¥˜ ë“± ë°©ì§€)
        // ë§ˆì§€ë§‰ ì¹´ë“œì˜€ë‹¤ë©´ ê²Œì„ ì¢…ë£Œ
        setGameStatus('ended'); 
      }
    }
  };

  const handleSecretSelect = (name) => {
    if (targetWinnerName === name) {
      setTargetWinnerName(null);
    } else {
      setTargetWinnerName(name);
    }
  };

  return (
    <div className="min-h-screen bg-slate-100 flex flex-col font-sans overflow-hidden">
      <style>{`
        @keyframes confetti {
          0% { transform: translateY(0) rotate(0deg); opacity: 1; }
          100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        .animate-confetti {
          animation-name: confetti;
          animation-timing-function: linear;
          animation-iteration-count: infinite;
        }
      `}</style>
      
      <Confetti active={gameStatus === 'ended'} />

      {/* í—¤ë” */}
      <header className="bg-white shadow-sm px-6 py-4 z-20 shrink-0">
        <div className="max-w-7xl mx-auto flex justify-between items-center">
          <div className="flex items-center gap-3">
            <div className="bg-indigo-600 text-white p-2 rounded-xl shadow-indigo-200 shadow-lg">
              <Users size={24} />
            </div>
            <div>
              <h1 className="text-xl font-bold text-slate-800">ìš°ë¦¬ ë°˜ ë°˜ì¥ ë½‘ê¸°</h1>
              <p className="text-xs text-slate-400">ì¹´ë“œë¥¼ ì„ íƒí•´ ì£¼ì¸ê³µì´ ë˜ì–´ë³´ì„¸ìš”</p>
            </div>
          </div>
          
          <button 
            onClick={initGame}
            className="flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 hover:bg-gray-50 text-gray-700 rounded-lg text-sm font-medium transition-colors shadow-sm active:scale-95"
          >
            <RefreshCw size={16} />
            <span>ë‹¤ì‹œ ì„ê¸°</span>
          </button>
        </div>
      </header>

      {/* ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ */}
      <div className="flex-1 flex flex-col lg:flex-row overflow-hidden max-w-7xl mx-auto w-full">
        
        {/* ì™¼ìª½: ì¹´ë“œ ê·¸ë¦¬ë“œ ì˜ì—­ */}
        <main className="flex-1 p-4 lg:p-8 overflow-y-auto">
          {gameStatus === 'ended' && (
            <div className="mb-6 bg-yellow-50 border border-yellow-200 rounded-2xl p-6 text-center shadow-sm animate-bounce">
              <h2 className="text-3xl font-bold text-yellow-700 mb-2">ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰</h2>
              <p className="text-xl text-yellow-800">
                ìƒˆë¡œìš´ ë°˜ì¥ì€ <span className="font-black underline decoration-wavy decoration-yellow-500">{shuffledStudents[currentTurnIndex]}</span> í•™ìƒì…ë‹ˆë‹¤!
              </p>
            </div>
          )}
          
          <div className="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 gap-3 sm:gap-4 pb-20">
            {cards.map(card => (
              <Card 
                key={card.id} 
                {...card} 
                onClick={handleCardClick}
                disabled={gameStatus === 'ended' || (card.isFlipped)} 
              />
            ))}
          </div>
        </main>

        {/* ì˜¤ë¥¸ìª½: í•™ìƒ ìˆœì„œ ë¦¬ìŠ¤íŠ¸ */}
        <aside className="w-full lg:w-80 bg-white border-t lg:border-t-0 lg:border-l border-gray-200 flex flex-col h-[30vh] lg:h-auto shadow-xl lg:shadow-none z-10">
          <div className="p-4 bg-gray-50 border-b border-gray-200 font-bold text-gray-700 flex justify-between items-center">
            <span>ìˆœì„œ ë¦¬ìŠ¤íŠ¸</span>
            <span className="text-xs font-normal text-gray-500 bg-white px-2 py-1 rounded border">
              {currentTurnIndex + 1} / {initialNames.length}
            </span>
          </div>
          <div className="flex-1 overflow-y-auto p-3 space-y-2">
            {shuffledStudents.map((name, idx) => {
              let status = 'waiting';
              if (idx < currentTurnIndex) status = 'done';
              if (idx === currentTurnIndex && gameStatus !== 'ended') status = 'current';
              if (gameStatus === 'ended' && idx === currentTurnIndex) status = 'current'; // Winner keeps highlight

              return (
                <StudentItem 
                  key={name} 
                  name={name} 
                  index={idx}
                  status={status}
                />
              );
            })}
          </div>
        </aside>

      </div>

      {/* ë¹„ë°€ ì„¤ì • ë²„íŠ¼ (ìš°ì¸¡ í•˜ë‹¨) */}
      <div className="fixed bottom-4 right-4 z-50">
        <button 
          onClick={() => !hasFirstCardFlipped && setIsSettingsOpen(true)}
          disabled={hasFirstCardFlipped}
          className={`p-2 rounded-full transition-all duration-300 ${hasFirstCardFlipped ? 'cursor-not-allowed opacity-0' : 'hover:bg-gray-200 cursor-pointer opacity-10 hover:opacity-50 text-gray-500'}`}
          title={hasFirstCardFlipped ? "ê²Œì„ ì§„í–‰ ì¤‘ì—ëŠ” ë³€ê²½ ë¶ˆê°€" : "ì„¤ì •"}
        >
          <Settings size={20} />
        </button>
      </div>

      {/* ë¹„ë°€ ì„¤ì • ëª¨ë‹¬ */}
      {isSettingsOpen && (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[85vh] flex flex-col overflow-hidden animate-in fade-in zoom-in duration-200">
            <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
              <h3 className="font-bold text-gray-800 flex items-center gap-2">
                <Settings size={18} />
                ë‹¹ì²¨ì ì§€ì • (ê´€ë¦¬ììš©)
              </h3>
              <button onClick={() => setIsSettingsOpen(false)} className="text-gray-400 hover:text-gray-600">
                <X size={20} />
              </button>
            </div>
            
            <div className="p-4 bg-blue-50 text-sm text-blue-800 border-b border-blue-100">
              <p>ì§€ì •ëœ í•™ìƒ ìˆœì„œê°€ ë˜ë©´ <strong>ì–´ë–¤ ì¹´ë“œë¥¼ ë½‘ë”ë¼ë„</strong> ë‹¹ì²¨ë©ë‹ˆë‹¤. ì²« ì¹´ë“œë¥¼ ë’¤ì§‘ê¸° ì „ê¹Œì§€ë§Œ ì„¤ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
            </div>

            <div className="overflow-y-auto flex-1 p-2">
              <div className="grid grid-cols-2 gap-2">
                <button
                  onClick={() => setTargetWinnerName(null)}
                  className={`p-3 rounded-lg text-sm font-medium border text-left flex justify-between items-center ${targetWinnerName === null ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'bg-white border-gray-200 hover:bg-gray-50'}`}
                >
                  <span>ğŸ² ëœë¤ í™•ë¥ </span>
                  {targetWinnerName === null && <Check size={16} />}
                </button>
                
                {initialNames.map(name => (
                  <button
                    key={name}
                    onClick={() => handleSecretSelect(name)}
                    className={`p-3 rounded-lg text-sm font-medium border text-left flex justify-between items-center transition-colors ${targetWinnerName === name ? 'bg-indigo-50 border-indigo-500 text-indigo-700 ring-1 ring-indigo-500' : 'bg-white border-gray-200 hover:bg-gray-50 text-gray-700'}`}
                  >
                    <span className="truncate">{name}</span>
                    {targetWinnerName === name && <Check size={16} />}
                  </button>
                ))}
              </div>
            </div>

            <div className="p-4 border-t border-gray-100 bg-gray-50 flex justify-end gap-2">
              <button 
                onClick={() => setIsSettingsOpen(false)}
                className="px-6 py-2 bg-gray-800 text-white rounded-lg font-medium hover:bg-gray-900 transition-colors"
              >
                ì„¤ì • ì™„ë£Œ
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

